name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create/update releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Create local.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace
      
      - name: Get commit info
        id: commit
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "DATE=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
      
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: KidsCuratedPlayer-debug
          path: app/build/outputs/apk/debug/KidsCuratedPlayer-v*.apk
          retention-days: 30
      
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: KidsCuratedPlayer-release
          path: app/build/outputs/apk/release/KidsCuratedPlayer-v*.apk
          retention-days: 30
      
      - name: Get APK Info
        run: |
          DEBUG_APK=$(ls app/build/outputs/apk/debug/KidsCuratedPlayer-*.apk | head -1)
          RELEASE_APK=$(ls app/build/outputs/apk/release/KidsCuratedPlayer-*.apk | head -1)
          echo "### ðŸ“± APK Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Debug APK:" >> $GITHUB_STEP_SUMMARY
          echo "**Name:** $(basename $DEBUG_APK)" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** $(ls -lh $DEBUG_APK | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Release APK:" >> $GITHUB_STEP_SUMMARY
          echo "**Name:** $(basename $RELEASE_APK)" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** $(ls -lh $RELEASE_APK | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… APKs are ready for download in the Artifacts section above!" >> $GITHUB_STEP_SUMMARY
      
      # PUBLIC DOWNLOAD - Create/Update "latest" release (NO LOGIN REQUIRED)
      - name: Create APKs with stable names for public download
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          DEBUG_APK=$(ls app/build/outputs/apk/debug/KidsCuratedPlayer-*.apk | head -1)
          RELEASE_APK=$(ls app/build/outputs/apk/release/KidsCuratedPlayer-*.apk | head -1)
          
          # Create stable names for latest builds
          cp $DEBUG_APK KidsCuratedPlayer-latest-debug.apk
          cp $RELEASE_APK KidsCuratedPlayer-latest.apk
          
          # Create timestamped versions
          cp $DEBUG_APK KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-debug.apk
          cp $RELEASE_APK KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-release.apk
      
      - name: Update Latest Release with APK (Public Download)
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: latest
          name: "ðŸ“± Latest Build (Auto-updated)"
          body: |
            ## ðŸš€ Latest Development Build
            
            **ðŸ“¥ PUBLIC DOWNLOAD - No GitHub Login Required!**
            
            This APK is automatically built from the latest `main` branch code.
            Anyone can download and install these APKs directly.
            
            ### ðŸ“² Quick Download:
            
            **ðŸŽ¯ Recommended (Smaller, Faster):**
            - **[KidsCuratedPlayer-latest.apk](https://github.com/${{ github.repository }}/releases/download/latest/KidsCuratedPlayer-latest.apk)** - Release build
            
            **ðŸ”§ Debug Version (Larger, More Info):**
            - **[KidsCuratedPlayer-latest-debug.apk](https://github.com/${{ github.repository }}/releases/download/latest/KidsCuratedPlayer-latest-debug.apk)** - Debug build
            
            ### Installation Instructions:
            1. Download the APK file (release version recommended)
            2. Transfer to your Android device
            3. Settings â†’ Security â†’ Enable "Install from Unknown Sources"
            4. Tap the APK file to install
            5. Launch "Kids Curated Player"
            
            ---
            
            ### ðŸ“Š Build Information:
            - **Commit:** ${{ github.sha }}
            - **Short SHA:** ${{ steps.commit.outputs.SHORT_SHA }}
            - **Build Date:** ${{ steps.commit.outputs.DATE }}
            - **Branch:** ${{ github.ref_name }}
            
            ### ðŸ”— Direct Download Links:
            **Release APK (Stable URL - always latest):**
            ```
            https://github.com/${{ github.repository }}/releases/download/latest/KidsCuratedPlayer-latest.apk
            ```
            
            **Debug APK (Stable URL - always latest):**
            ```
            https://github.com/${{ github.repository }}/releases/download/latest/KidsCuratedPlayer-latest-debug.apk
            ```
            
            **Timestamped builds (this specific commit):**
            - Release: `KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-release.apk`
            - Debug: `KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-debug.apk`
            
            ### ðŸ“š Documentation:
            - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/INSTALLATION_GUIDE.md)
            - [Release Notes v1.0.0](https://github.com/${{ github.repository }}/blob/main/RELEASE_NOTES_v1.0.0.md)
            - [Quick Start Guide](https://github.com/${{ github.repository }}/blob/main/QUICK_START.md)
            
            ---
            
            âš ï¸ **Note:** This is a development build updated automatically with each push.
            For stable releases, check the [Releases page](https://github.com/${{ github.repository }}/releases).
          files: |
            KidsCuratedPlayer-latest.apk
            KidsCuratedPlayer-latest-debug.apk
            KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-release.apk
            KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-debug.apk
          draft: false
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Display Public Download Links
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "### ðŸŒ PUBLIC APK DOWNLOAD (No Login Required)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Anyone can download these APKs without logging in to GitHub!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¥ Release APK (Recommended - Smaller, Faster):**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/download/latest/KidsCuratedPlayer-latest.apk" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ï¿½ Debug APK (Larger, More Debug Info):**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/download/latest/KidsCuratedPlayer-latest-debug.apk" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¦ Timestamped Builds:**" >> $GITHUB_STEP_SUMMARY
          echo "- Release: KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-release.apk" >> $GITHUB_STEP_SUMMARY
          echo "- Debug: KidsCuratedPlayer-${{ steps.commit.outputs.DATE }}-${{ steps.commit.outputs.SHORT_SHA }}-debug.apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŒ Release Page:**" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Share these links with anyone - no GitHub account needed!**" >> $GITHUB_STEP_SUMMARY
